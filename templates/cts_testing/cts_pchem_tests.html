<script type="text/javascript" src="/static_qed/cts/stylesheets/jquery.validate.js"></script>

<script type="text/javascript">

var UnitTest = {

	webservice_data: [],  // original pchem data from calc services
	webservice_data_parsed: [],  // p-chem responses wrapped like csv_pchem_array
	csv_pchem_array: [],
	csv_output_array: [],
	batch_chems: [],  // "nodes" replacement
	final_data_array: {
		'input_csv_data': [],  // e.g., [{prop-key: prop-val}, ...
		'ws_csv_data': [],
		'std_dev': []
	},  // csv_pchem_array, webserver_data, std dev

	init: function (settings) {
		// any config stuff, initializing..
		UnitTest.setup();
	},

	setup: function () {

		$('.input_nav').hide();

		$('#upfile1').change(function (evt) {

			var data = null;
			var file = evt.target.files[0];
			var final_csv_array = [];

			var reader = new FileReader();
			reader.readAsText(file);
			reader.onload = function (e) {

				var csv_data = reader.result;
				var csv_array = csv_data.split('\n');  // array item is row in csv
				csv_array.pop();  // remove trailing blank array

				var headers = csv_array[0].split(',');

				for (var i = 1; i < csv_array.length; i++) {
					final_csv_array.push(csv_array[i].split(','));  // csv --> array of arrays

					UnitTest.csv_pchem_array.push([]);
					var pchem_array = csv_array[i].split(',');  // an array of pchem data

					// array item is per chemical, and is one big object instead
					// of array of array with items being key:val..

					// var data_obj = {};

					// for (var j = 0; j < pchem_array.length; j++) {
					// 	data_obj[headers[j]] = final_csv_array[i -1][j];
					// }
					// UnitTest.csv_pchem_array[i - 1].push(data_obj);
					// UnitTest.csv_pchem_array.push(data_obj);

					for (var j = 0; j < pchem_array.length; j++) {
						var data_obj = {};
						data_obj[headers[j]] = final_csv_array[i - 1][j];
						UnitTest.csv_pchem_array[i - 1].push(data_obj);
					}

				}

				if (final_csv_array && final_csv_array.length > 0) {
					UnitTest.displayCSVChemicals(final_csv_array);
				}
				else {
					alert("No data imported");
				}
			};
			reader.onerror = function () {
				alert("Unable to read " + file.fileName);
			};

		});

		$('.submit').click(function (event) {
		
			// cts_pchempro_requests.html in ubertool_cts/templates/ functions:
	        checkedCalcsAndProps = buildCheckedCalcsAndProps();
	        blockInterface(true);
	        total_calls = calculateTotalCalls([UnitTest.batch_chems.length], checkedCalcsAndProps);
	        calls_tracker = total_calls;

	        UnitTest.pchemRequests(checkedCalcsAndProps);

		});

	},

	pchemRequests: function (checkedCalcsAndProps) {

		var socket;

		// connect to socket.io!
        if (nodejs_host == 'nginx') {
            socket = io.connect();  // docker way
        }
        else {
            if (nodejs_port && nodejs_port != 80) {
                socket = io.connect('http://' + nodejs_host + ':' + nodejs_port, {'force new connection': true});
            }
            else {
                socket = io.connect(nodejs_host, {'force new connection': true});
            }
        }

		var pchem_data = {
	        'chemical': structure,
	        'ph': kowPH,
	      	'nodes': UnitTest.batch_chems,
	        'pchem_request': checkedCalcsAndProps
	    };

	    var cache = [];
	    var pchem_data_json = JSON.stringify(pchem_data, function(key, value) {
	        if (typeof value === 'object' && value !== null) {
	            if (cache.indexOf(value) !== -1) {
	                // Circular reference found, discard key
	                return;
	            }
	            // Store value in our collection
	            cache.push(value);
	        }
	        return value;
	    });
	    cache = null; // Enable garbage collection

	    socket.emit('get_data', pchem_data_json);

	    socket.on('message', function (data) {

	    	calls_tracker--;
            console.log("calls tracker: " + calls_tracker);

            var data_obj = JSON.parse(data);

            UnitTest.webservice_data.push(data_obj);

			if (calls_tracker <= 0) {
	            console.log("All data retrieved!");
	            blockInterface(false);

	            // once all the webservice data is collected,
	            // convert it to the same format as csv_pchem_array!

	            UnitTest.parseWebserviceDataForCSV();

			}

		});
	},

	displayCSVChemicals: function (csv_array) {
		var batch_chems = [];
		for (var i = 0; i < csv_array.length; i++) {
			// build smiles array (1st item of each csv item, skip 1st one, which is headers)
			batch_chems.push(csv_array[i][0]);
			UnitTest.batch_chems.push({'smiles': csv_array[i][0]});  // "nodes" replacement
		}

		// only allow ten max for now:
		if (batch_chems.length > 10) {
			alert("Early batch version is only accepting a maximum of 10 chemicals at a time. This will be increased in the near future. Try reducing the number of chemicals in the file, refresh the page, and try again..");
			return;
		}

		var batch_inputs = $('#pchem_batch_wrap');
		$(batch_inputs).show();
		$(batch_inputs).children().show();
		$('#cont, #reactionpathways').hide();  // todo: separate html and js in ts_gentrans_tree.html

		for (chem in batch_chems) {
			$('#batch_list').append('<li>' + batch_chems[chem] + '</li>');
		}

		$('#batchfilewrap').show();
		$('#pchemprop_table').show();
		$('.input_nav').show();
	},

	parseWebserviceDataForCSV: function () {

		var ws_data = UnitTest.webservice_data;

		// will the ws and csv smiles always align???
		// NOTE: currently making a new row per ws data,
		// which is incorrect. There will be more ws datum than rows.

		// Maybe the main loop should be the CSV data instead,
		// then loop ws data for each CSV datum.


		for (var i = 0; i < UnitTest.csv_pchem_array.length; i++) {

			// loopin each row..

			var new_row = [];
			new_row.push(UnitTest.csv_pchem_array[i][0]);  // smiles

			for (var csv_index in UnitTest.csv_pchem_array[i]) {

				// loopin key:val obj of csv row's data..

				var csv_pair = UnitTest.csv_pchem_array[i][csv_index];
				var csv_key = Object.keys(csv_pair)[0];  // should only be one item
				var csv_val = Number(csv_pair[csv_key]);

				for (var j = 0; j < ws_data.length; j++) {

					// loopin ws data to match csv data..

					var smiles_ws = ws_data[j]['chemical'];
					var prop_ws = ws_data[j]['prop'];
					var calc_ws = ws_data[j]['calc'];
					var data_ws = ws_data[j]['data'];

					if (csv_key.indexOf(calc_ws) > -1 && csv_key.indexOf(prop_ws) > -1) {

						// only build output csv with selected calcs-props
						// values for both csv and ws data.

						var csv_key_new = csv_key + " csv";
						var csv_obj = {};
						csv_obj[csv_key_new] = csv_val;
						new_row.push(csv_obj);

						csv_key_new = csv_key + " ws";
						var csv_obj = {};
						csv_obj[csv_key_new] = data_ws;
						new_row.push(csv_obj);

						// todo: make calculations separate UnitTest function
						var data_diff = Math.abs(csv_val - data_ws);
						var data_avg = (csv_val + data_ws) / 2;
						var percent_diff = 100 * (data_diff / data_avg);

						csv_key_new = csv_key + " % diff";
						var csv_obj = {};
						csv_obj[csv_key_new] = percent_diff;
						new_row.push(csv_obj);

					}

				}

			}
			UnitTest.csv_output_array.push(new_row);

		}
		console.log(UnitTest.csv_output_array);
		var csv_output_data = UnitTest.csv_output_array;
		UnitTest.sendCSVDataToServer(csv_output_data);
		UnitTest.csv_output_array = [];  // garbage collection

	},

	sendCSVDataToServer: function (csv_output_data) {

		// creates a csv from UnitTest.csv_output_array data

		// traditional way: redirect to csv file location
		// location.replace('/to/csv/file');  // widely supported
		// html5 way: download property in anchor tag
		// $('div below pchem table').append('<a download="nameofcsvfile" href="/to/csv/file">Download CSV</a>');

		// location.replace('/cts/testing/csv');
		// $('#csvExport').click(function () {

	        var cache = [];
			json_data = JSON.stringify(csv_output_data, function(key, value) {
			    if (typeof value === 'object' && value !== null) {
			        if (cache.indexOf(value) !== -1) {
			            return;  // Circular reference found, discard key
			        }
			        cache.push(value);
			    }
			    return value;
			});
			cache = null;  // Enable garbage collection

			// $('table.getpdf').html("");
			$('form').append('<table class="getpdf"></table>');
			$('<tr style="display:none"><td><input type="hidden" name="csv_data"></td></tr>')
					.appendTo('.getpdf')
					.find('input')
					.val(json_data);

			$('form').attr({'action': 'csv', 'method': 'POST'}).submit();

		// });

	}

};
$(document).ready(UnitTest.init);

</script>
</form> <!-- end submit form -->
</div> <!-- End "articles" div -->
